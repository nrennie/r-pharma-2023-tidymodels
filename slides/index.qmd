---
title: "Introduction to machine learning with {tidymodels}"
subtitle: "R/Pharma 2023"
author: "Dr Nicola Rennie"
format:
  LUstyle-revealjs:
    footer: "[nrennie.github.io/r-pharma-2023-tidymodels](https://nrennie.github.io/r-pharma-2023-tidymodels)"
bibliography: references.bib
---

# Welcome!

## What to expect during this workshop

The workshop will run for *2 hours*.

* We'll take a 5 minute break halfway through.

* Combines slides, live coding examples, quiz questions, and exercises for you to participate in.

* Ask questions in the chat throughout!

## What to expect during this workshop

::: columns
::: {.column}

<br>

I hope you end up with more questions than answers after this workshop!

:::

::: {.column .center}

![](images/questions.gif){fig-align="center" fig-alt="Stranger Things questions gif" width=80%}

<small>Source: <a href="https://giphy.com/gifs/netflix-stranger-things-4-st4-cn7GcSZ1KWqO7CJw1B">giphy.com</a></small>

:::
:::


## Workshop resources

::: columns
::: {.column}

* GitHub: [github.com/nrennie/r-pharma-2023-tidymodels](https://github.com/nrennie/r-pharma-2023-tidymodels)

* Slides: [nrennie.github.io/r-pharma-2023-tidymodels](https://nrennie.github.io/r-pharma-2023-tidymodels)

:::
::: {.column}

![](images/qr-code.png){fig-align="center" fig-alt="QR code" width=70%}

:::

:::

## Data

We'll use two data sets in this workshop:

* Examples data: Heart Failure Clinical Records. [archive.ics.uci.edu/dataset/519/heart+failure+clinical+records](http://archive.ics.uci.edu/dataset/519/heart+failure+clinical+records)

```{r}
#| label: read-data-example
#| echo: true
#| eval: false
heart_failure <- readr::read_csv("data/heart_failure.csv") 
```

<br>

* Exercises data: Physical Exercise in Patients with Subacute Stroke (PHYS-STROKE): safety analyses of six-month follow-up of a randomized clinical trial. [doi.org/10.5281/zenodo.3899830](https://doi.org/10.5281/zenodo.3899830)

```{r}
#| label: read-data-exercises
#| echo: true
#| eval: false
exercises <- readr::read_csv("data/exercises.csv") 
```

# Getting started with \{tidymodels\} {background-color="#D9DBDB"}

## What is {tidymodels}?

::: columns
::: {.column}

* A collection of R packages for statistical modelling and machine learning.

* Follows the {tidyverse} principles.

* `install.packages("tidymodels")`

:::

::: {.column}

![](images/tidymodels-pkgs.png){fig-align="center" fig-alt="tidymodels packages hex sticker logo" width=80%}

<small>Source: <a href="https://rpubs.com/chenx/tidymodels_tutorial">rpubs.com/chenx/tidymodels_tutorial</a></small>

:::
:::

## What is {tidymodels}?

There are some core {tidymodels} packages...

![](images/tidymodels.png){fig-align="center" fig-alt="tidymodels R package hex sticker logo" width=50%}


... and plenty of extensions!

## What is machine learning?

## Quiz!

Have you done machine learning in R before?

* No

* Yes, with {tidymodels}

* Yes, with {caret}

* Yes, with something else

## Types of machine learning

Aim:

* Classification
* Prediction


Process:

* Supervised
* Unsupervised

. . . 

* Semi-supervised

# Before we start fitting models... {background-color="#D9DBDB"}

## Training and testing

## Hyperparameter tuning

Cross-validation

## Workflows and recipes

## Pre-processing in {tidymodels}

### Live demo!

. . . 

<br><br>

See `examples/example_01.R` for full code.

## Exercise 1

Open `exercises/exercise_01.R` for prompts.

* Load the {tidyverse} and {tidymodels} packages

* Read in the `exercises.csv` data

* View and explore the data

* Perform the initial split (choose your own proportion!)

* Create some cross-validation folds

* Build a recipe and workflow

```{r}
#| label: ex-1-timer
countdown::countdown(minutes = 10,
                    color_border = "#b20e10",
                    color_text = "#b20e10",
                    color_running_text = "white",
                    color_running_background = "#b20e10",
                    color_finished_text = "#b20e10",
                    color_finished_background = "white",
                    top = 0,
                    margin = "1.2em",
                    font_size = "2em")
```

. . . 

See `exercise_solutions/exercise_solutions_01.R` for full code.

# Lasso regression {background-color="#D9DBDB"}

## Linear and logistic regression models

Let's go back a little bit first... 

. . . 

::: columns

::: {.column}
**Linear regression**
```{r}
#| label: lin-reg
#| eval: false
#| echo: true
lm(y ~ x, data = model_data)
```

![](images/lasso_01.png){fig-align="center" fig-alt="Linear regression plot" width=70%}
:::

::: {.column .fragment}
**Logistic regression**

```{r}
#| label: log-reg
#| eval: false
#| echo: true
glm(y ~ x, family = "binomial", data = model_data)
```
![](images/lasso_02.png){fig-align="center" fig-alt="Linear regression plot" width=70%}
:::

:::

## Quiz!

How do you choose which explanatory variables to include?

## Lasso regression

::: columns
::: {.column}

LASSO = Least Absolute Shrinkage and Selection Operator

:::
::: {.column}
:::
:::

## Hyperparameters for LASSO regression

**$\lambda$ (penalty)** = Between 0 and $\infty$

* Higher value: more coefficients are pushed towards zero

* Lower value: closer to standard regression models. ($\lambda = 0$ ~ standard regression model)

## Model evaluation

::: columns
::: {.column}

**(Binary) Classification Metrics**

* Accuracy: proportion of the data that are predicted correctly.

* ROC AUC: area under the ROC (receiver operating characteristic) curve.

* Kappa: similar to accuracy but normalised by the accuracy expected by chance alone.

:::
::: {.column .fragment .center}

![](images/roc.png){fig-align="center" fig-alt="ROC curve" width=100%}
<small>Source: <a href="https://commons.wikimedia.org/wiki/File:Roc-draft-xkcd-style.svg#filelinks">Martin Thoma (Wikipedia)</a></small>
:::
:::

See [yardstick.tidymodels.org/articles/metric-types.html](https://yardstick.tidymodels.org/articles/metric-types.html).

## Lasso logistic regression in {tidymodels}

### Live demo!

. . . 

<br><br>

See `examples/example_02.R` for full code.


## Exercise 2

Open `exercises/exercise_02.R` for prompts. You can also use `examples/example_02.R` as a starting point.

* Specify the model using `logistic_reg()`.

* Tune the hyperparameter.

* Choose the best value and fit the final model.

* Evaluate the model performance.

```{r}
#| label: ex-2-timer
countdown::countdown(minutes = 10,
                    color_border = "#b20e10",
                    color_text = "#b20e10",
                    color_running_text = "white",
                    color_running_background = "#b20e10",
                    color_finished_text = "#b20e10",
                    color_finished_background = "white",
                    top = 0,
                    margin = "1.2em",
                    font_size = "2em")
```

. . . 

See `exercise_solutions/exercise_solutions_02.R` for full code.

# Random Forests {background-color="#D9DBDB"}

## Decision trees

::: columns
::: {.column}
:::
::: {.column}
:::
:::

## What are Random Forests?

::: columns
::: {.column}
:::
::: {.column}
:::
:::

## Random Forests in {tidymodels}

### Live demo!

. . . 

<br><br>

See `examples/example_03.R` for full code.

## Exercise 3

Open `exercises/exercise_03.R` for prompts. You can also use `examples/example_03.R` as a starting point.

* Specify a random forest model using `rand_forest()`

* Tune the hyperparameters using the cross-validation folds.

* Fit the final model and evaluate it.

```{r}
#| label: ex-3-timer
countdown::countdown(minutes = 10,
                    color_border = "#b20e10",
                    color_text = "#b20e10",
                    color_running_text = "white",
                    color_running_background = "#b20e10",
                    color_finished_text = "#b20e10",
                    color_finished_background = "white",
                    top = 0,
                    margin = "1.2em",
                    font_size = "2em")
```

. . . 

See `exercise_solutions/exercise_solutions_03.R` for full code. 

# Support Vector Machines (SVM) {background-color="#D9DBDB"}

## What are Support Vector Machines?

::: columns
::: {.column}

Support Vector Machines (SVMs) draw a decision boundary that best separates two groups.

:::
::: {.column}

![](images/svm_01.png){fig-align="center" fig-alt="Scatter plot with two groups" width=100%}
:::
:::

## What are Support Vector Machines?

::: columns
::: {.column}

Support Vector Machines (SVMs) draw a decision boundary that best separates two groups.

:::
::: {.column}

![](images/svm_02.png){fig-align="center" fig-alt="Scatter plot with two groups with dividing line" width=100%}
:::
:::

## Types of SVM

There are different types of *kernel* functions, including:

::: columns
::: {.column width="33%" .center}
Linear

`svm_linear()`

![](images/svm_03.png){fig-align="center" fig-alt="linear kernel plot" width=100%}
:::

::: {.column width="33%" .center}
Polynomial

`svm_poly()`

![](images/svm_04.png){fig-align="center" fig-alt="polynomial kernel plot" width=100%}
:::

::: {.column width="33%" .center}
Radial Basis Functions

`svm_rbf()`

![](images/svm_05.png){fig-align="center" fig-alt="RBF kernel plot" width=100%}
:::

:::

## Hyperparameters in SVMs

**Cost**

* Higher value: emphasises fitting the data

* Lower value: prioritises avoiding overfitting

**Gamma** (shape and smoothness of decision boundary)

* Higher value: more flexible boundaries

* Lower value: simpler boundaries

There may be other hyperparameters, depending on the choice of kernel.

## Support Vector Machines in {tidymodels}

### Live demo!

. . . 

<br><br>

See `examples/example_04.R` for full code.

## Exercise 4

Open `exercises/exercise_04.R` for prompts. You can also use `examples/example_04.R` as a starting point.

* Specify a support vector machine using `svm_rbf()` (or one of the other `svm_*` functions if you're feeling confident!)

* Tune the `cost()` hyperparameter using the cross-validation folds.

* Fit the final model and evaluate it.

* Look at some other evaluation metrics.

```{r}
#| label: ex-4-timer
countdown::countdown(minutes = 10,
                    color_border = "#b20e10",
                    color_text = "#b20e10",
                    color_running_text = "white",
                    color_running_background = "#b20e10",
                    color_finished_text = "#b20e10",
                    color_finished_background = "white",
                    top = 0,
                    margin = "1.2em",
                    font_size = "2em")
```

. . . 

See `exercise_solutions/exercise_solutions_04.R` for full code.

# Additional Information {background-color="#D9DBDB"}

## Additional Information

There are many machine learning models and {tidymodels} functions we haven't covered today.

## Additional resources

::: columns

::: {.column}

* [{tidymodels} documentation](https://www.tidymodels.org/)

* [Tidy Modeling with R](https://www.tmwr.org/)

* [Blog by Julia Silge](https://juliasilge.com/blog/)

:::

::: {.column}

![](images/tmwr.png){fig-align="center" fig-alt="Tidy modelling with R cover" width=70%}

:::

:::

## Workshop resources

* GitHub: [github.com/nrennie/r-pharma-2023-tidymodels](https://github.com/nrennie/r-pharma-2023-tidymodels)

* Slides: [nrennie.github.io/r-pharma-2023-tidymodels](https://nrennie.github.io/r-pharma-2023-tidymodels)


## 

::: columns
::: {.column}

<br>

{{< fa brands twitter >}} [\@nrennie35](https://twitter.com/nrennie35)

{{< fa brands github >}} [nrennie](https://github.com/nrennie)

{{< fa globe >}} [nrennie.rbind.io](https://nrennie.rbind.io/)

{{< fa briefcase >}} [chicas.lancaster-university.uk](https://chicas.lancaster-university.uk/)

:::
::: {.column}

![](images/qr-code.png){fig-align="center" fig-alt="QR code" width=70%}

:::
:::

